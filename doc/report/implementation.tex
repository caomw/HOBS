\section{Implementation}
\label{sec:implementation}

In this section, we detail our implementation on Arduino \cite{Arduino} platform. The whole system is comprised of a glass module, numbers of clients, and a gateway, as shown in the architecture figure (Fig.\,\ref{fig:sysarch}) in the last section. We will start from the clients, whose primary tasks are to interface between the Glass and the devices that are attached to it. Then we move on to the implementation of the Glass, which manages user's gesture recognition and communication with the clients. The functionality of the gateway so far is confined to only communicate with the clients, since it's not the primary focus of this project.

\subsection{Clients}
The clients are comprised of a main Arduino board, an IR receiver, an XBee radio, and various actuators. We used Arduino Uno, which has an ATmega328 microcontroller and suffice our purpose in this project. We use off-the-shell IR receivers ({\color{red} confirm it is PNA4602}), which outputs 0V (low) on detection of 38 KHz carrier or 5V (high) otherwise. The XBee radio, accompanied with an XBee modems, takes charge of the communication with the Glass. LEDs are added as an indicator of the state of clients and visual feedback for users. Additional components are subject to the device being attached to. In our current system, we have a relay ({\color{red} need to know relay model}) which can control the AC power plug, and we have a USB connected computer to control video playing. The prototype is shown in Fig.\,\ref{fig:client}.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{../figs/client.png}
  \caption{Prototype of the clients}
  \label{fig:client}
\end{figure}

The main function of the client is to respond IR signal and communicate with the Glass to receive commands from the user. Normally, the client stays in {\it IDLE} mode. When it receives an IR signal, suggesting that the user could be interested in interacting with it, the client responds with an XBee acknowledgement and goes into {\it PENDING} state. The glass, after seding the IR, will wait for a certain amoount of time. If there is only one client responding during the wait, the Glass will directly send a connecting message to the only client. When there are multiple clients responding, the Glass will broadcast a verify message with a client ID. The client with a matching ID is called the active client and its LED will blink faster then the others as a visual feedback to the user. After the user decide which one to connect with, the Glass will send out a connecting message. Client turned into {\it CONNECTED} state will be ready to take commands. To summarize the clients' behavior, we have a state machine in Fig.\,\ref{fig:clientFSM} for illustration.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{../figs/clientFSM.pdf}
  \caption{FSM model for client. For each transition, ``e'' stands for event, and ``a'' stands for action}
  \label{fig:clientFSM}
\end{figure}

Within {\it CONNECTED} state, the clients will react differently according to the device it is connected to. In our prototype, we have two different types of devices. The first is a relay, which can control the whole AC power supply. The interface to relay is simply an digital pin. We only need to set it to {\it LOW} or {\it HIGH}. Such command is transmitted remotely from the Glass through XBee using encoded packet. The second tyep is a computer that is used to play video. To send command to the computer, we have a USB adaptor and a python script taking charge of the translation. We use the {\it pyserial} and {\it appscript} library to trigger the play, pause command of an video, and system-wide volume control.

\subsection{Glass}
\label{sec:glass}

The Glass is complicated in two folds. First, we move the complexity of coordinating all clients to the Glass. Second, we have to handle user gesture on Glass. From an engineer perspective, we separate the gesture detection and XBee transmission into two customized library files in Arduino. And only relevant information is sent to the main program. We use the same Arduino Uno and XBee module as the client. An IR emitter is placed within a black tube in order to make the signal a straight beam of light. Then the the tube is attached to the Glass and adjusted in a proper direction. In addition, we have a membrane potentiometer (100 mm long) as the slider to take user's input. After we've put the components onto the Glass, we have the prototype shown in Fig.\,\ref{fig:glass}.

\begin{figure}
  \centering
  \includegraphics[width=0.85\linewidth]{../figs/glass.png}
  \caption{Prototype of the Glass}
  \label{fig:glass}
\end{figure}


The whole work flow on the Glass is as follows. When the user hasn't shown any interest for interaction, the Glass stays in {\it IDLE} state. When ``tapping'' is detected, the Glass will send a beam of IR signal to inform the devices which are in front of the user. The Glass waited for a specific period of time and count the number of acknowledgement messages responded by the clients. To ensure responsiveness to end user, we set the timer in {\it WAIT} state to be 1 second. When the timer expires, Glass will go to {\it IDLE} if no client has responded, or {\it CONFIRM} if it receives just one message. However, the complicated case is when there are multiple clients that have received the IR signal (because they are near to each other) and responded. Though we expect this scenario rarely happens, there is still chance when the physical devices are put together and it is necessary to differentiate them. In this case, the system goes to {\it VERIFY} state, and sends out corresponding verifying message based on user's gesture. The user can slide back and forth to select the desired target. Once the user confirmed the selection and release his finger, it goes to {\it CONNECTED} state and now the Glass is ready to send out commands. We have the FSM in Fig.\,\ref{fig:glassFSM}.

We've configured the XBee modules such that the Glass can talk in both direction with all clients, while clients cannot talk with each other. In this way, the Glass would serve as master of this personal area network (PAN), whose ID is 4321 in our scenario. 

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{../figs/glassFSM.pdf}
  \caption{FSM model for Glass. For each transition, ``e'' stands for event, and ``a'' stands for action}
  \label{fig:glassFSM}
\end{figure}

\subsection{Gateway}
\label{sec:gateway}

The gateway provides access to this PAN for computers, and presumably this can be further open to the Internet. Since there have already been many products \cite{NinjaBlocks, Lockitron} that essentially function in this way, we do not spend much time on this aspect in our project. 

For completeness, we wrote a python script that controls a USB XBee adaptor. And this XBee module has the same configuration as the Glass, so it serves as the master of the network. This enables the remote control of the clients.


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "main"
%%% End: 
